---
import BaseLayout from "./BaseLayout.astro";
import TableOfContents from "../components/TableOfContents.astro";
import "remark-github-blockquote-alert/alert.css";
import "../styles/post.css";
const { frontmatter, headings } = Astro.props;
---

<style>
	.post-container {
		gap: 2rem;
		display: flex;
		flex-direction: column;
	}

	.post-header {
		display: flex;
		flex-direction: column;
		gap: 1rem;
		border-bottom: 2px solid var(--accent);
		padding-bottom: 2rem;
	}
	.post-title {
		font-weight: 500;
		font-size: 1.5rem;
	}

	.post-pub-date,
	.post-edit-date {
		color: var(--text-secondary);
		font-size: 1rem;
	}
</style>

<BaseLayout>
	<section class="post-container">
		<div class="post-header">
			<h1 class="post-title">{frontmatter.title}</h1>
			<p class="post-pub-date">Published: {frontmatter.pubDate}</p>
			{
				frontmatter.editDate &&
					frontmatter.pubDate.valueOf() !== frontmatter.editDate.valueOf() && (
						<p class="post-edit-date">Updated: {frontmatter.editDate}</p>
					)
			}
		</div>
		<TableOfContents headings={headings} />
		<div class="post-content">
			<slot />
		</div>
	</section>
</BaseLayout>

<script>
	document.addEventListener("DOMContentLoaded", () => {
		const codeBlocks = document.querySelectorAll<HTMLPreElement>(".post-content pre");

		codeBlocks.forEach((pre) => {
			const code = pre.querySelector("code");
			if (!code) return;

			// Check for data-language attribute on pre element
			const language = pre.getAttribute("data-language");
			if (!language) return;

			// Exclude plain text/terminal output blocks
			const isPlainText =
				language === "text" ||
				language === "shell" ||
				language === "bash" ||
				language === "terminal";

			if (isPlainText) return;

			// Create wrapper div
			const wrapper = document.createElement("div");
			wrapper.className = "code-block-wrapper";

			// Wrap the pre element
			pre.parentNode?.insertBefore(wrapper, pre);
			wrapper.appendChild(pre);

			// Create copy button
			const button = document.createElement("button");
			button.className = "copy-button";
			button.setAttribute("aria-label", "Copy code to clipboard");

			// Copy icon SVG
			const copyIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>`;

			// Checkmark icon SVG
			const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;

			button.innerHTML = copyIcon;

			// Add click handler
			button.addEventListener("click", async () => {
				const codeText = code.textContent || "";
				try {
					await navigator.clipboard.writeText(codeText);
					button.innerHTML = checkIcon;
					button.classList.add("copied");
					setTimeout(() => {
						button.innerHTML = copyIcon;
						button.classList.remove("copied");
					}, 2000);
				} catch (err) {
					console.error("Failed to copy:", err);
				}
			});

			wrapper.appendChild(button);
		});
	});
</script>
